<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="referrer" content="no-referrer" />

    <title>JIT Groups</title>

    <!-- All external resources are hosted by Google -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,300,0,0" />

    <link href="mdc/material-components-web.min.css" rel="stylesheet">
    <script src="mdc/material-components-web.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main class="mdc-top-app-bar--fixed-adjust">
        <!-- EnvironmentInfoView -->
        <div class='jit-view' id='jit-environmentinfo-view'>
            <h1>Systems</h1>
            <div class="jit-card-subsection">
                <span class="jit-provisioner-description"></span>
            </div>
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">System</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Description</th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="jit-card-subsection">
                <a class="mdc-button mdc-button--outlined mdc-button--icon-leading" target="_blank" href="#">
                    <span class="mdc-button__ripple"></span>
                    <i class="material-icons mdc-button__icon" aria-hidden="true">download</i>
                    <span class="mdc-button__label">Download policy</span>
                </a>
            </div>
        </div>

        <!-- SystemInfoView -->
        <div class='jit-view' id='jit-systeminfo-view'>
            <h1>
                <a class="jit-provisioner-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <span class="jit-system-name"></span>
            </h1>
            <div class="jit-card-subsection">
                <span class="jit-system-description"></span>
            </div>
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Group</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Description</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Membership</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Allowed to join</th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GroupInfoView -->
        <div class='jit-view' id='jit-groupinfo-view'>
            <h1>
                <a class="jit-provisioner-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <a class="jit-system-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <span class="jit-group-name"></span>
            </h1>

            <div class="jit-card-subsection">
                <span class="jit-group-description"></span>
                <ul class="mdc-list jit-group-details"></ul>
            </div>
            <div class="jit-card-subsection">
                <ul class="mdc-list jit-group-privileges" title="This group grants the following privileges:"></ul>
            </div>
            <div class="jit-card-subsection">
                <ul class="mdc-list jit-group-membership" title="Your membership:"></ul>
            </div>
            <div class="jit-card-subsection">
                <ul class="mdc-list jit-group-constraints" title="Membership of this group is subject to the following constraints:"></ul>
            </div>

            <div class="jit-card-subsection jit-form">
                <form title="To join the group or extend your membership, provide the following information:">
                </form>

                <button class="mdc-button mdc-button--raised" type="submit">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Request access</span>
                </button>
            </div>

        </div>

        <!-- WaitDialog -->
        <div class="mdc-dialog" id="jit-wait-dialog">
            <div class="mdc-dialog__container">
                <div class="mdc-dialog__surface" role="alertdialog" aria-modal="true">
                    <h2 class="mdc-dialog__title">Please wait...</h2>
                    <div class="mdc-dialog__content">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate" aria-label="Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffer">
                                <div class="mdc-linear-progress__buffer-bar"></div>
                                <div class="mdc-linear-progress__buffer-dots"></div>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                                <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                                <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- script -->
    <script src="model.js"></script>
    <script src="view.js"></script>
    <script>
        "use strict"

        class WaitDialog extends DialogBase {
            constructor() {
                super('#jit-wait-dialog');

                const progressBar = new mdc.linearProgress.MDCLinearProgress(this.select('.mdc-linear-progress').get(0));
            }
        }

        class GroupsViewBase extends ViewBase {
            constructor(selector) {
                super(selector);
            }

            _formatExpiry(expiryEpoch) {
                const expiryInSecs = expiryEpoch - (new Date().getTime() / 1000);
                if (expiryInSecs > 24 * 60 * 60) {
                    const daysLeft = Math.floor(expiryInSecs / (24 * 60 * 60));
                    return `${daysLeft} day${daysLeft > 1 ? 's' : ''} left`;
                }
                else if (expiryInSecs > 60 * 60) {
                    const hoursLeft = Math.floor(expiryInSecs / (60 * 60));
                    return `${hoursLeft} hour${hoursLeft > 1 ? 's' : ''} left`;
                }
                else if (expiryInSecs > 60) {
                    const minutesLeft = Math.floor(expiryInSecs / 60);
                    return `${minutesLeft} minute${minutesLeft > 1 ? 's' : ''} left`;
                }
                else {
                    const secondsLeft = Math.floor(expiryInSecs);
                    return `${secondsLeft} seconds left`;
                }
            }
        }

        class EnvironmentInfoView extends GroupsViewBase {
            constructor(model) {
                super('#jit-environmentinfo-view');

                console.assert(model);

                this.table = new mdc.dataTable.MDCDataTable(this.select('table').get(0));
                this.table.clearRows();

                this.select('h1').text(model.content.name);
                this.select('.jit-provisioner-description').text(model.content.description);

                this.select('.mdc-button')
                    .prop('href', model.content.export != null ? model.content.export.href : '#')
                    .toggle(model.content.export != null);

                if (model.content.systems) {
                    model.content.systems.forEach(item => {
                        this.table.addRow(
                            item.id,
                            [
                                { text: item.name, icon: 'deployed_code', href: `#!/${item.self.href}` },
                                { text: item.description, maxLength: 40 }
                            ],
                            false);
                    });
                }
            }
        }

        class SystemInfoView extends GroupsViewBase {
            constructor(model) {
                super('#jit-systeminfo-view');

                console.assert(model);

                this.table = new mdc.dataTable.MDCDataTable(this.select('table').get(0));
                this.table.clearRows();

                this.select('.jit-provisioner-name')
                    .text(model.content.provisioner.name)
                    .prop('href', `#!/${model.content.provisioner.self.href}`);
                this.select('.jit-system-name').text(model.content.name);
                this.select('.jit-system-description').text(model.content.description);

                if (model.content.groups) {
                    model.content.groups.forEach(item => {
                        this.table.addRow(
                            item.id,
                            [
                                { text: item.name, icon: 'group', href: `#!/${item.self.href}` },
                                { text: item.description, maxLength: 70 },
                                {
                                    text: item.access.membership.active ? this._formatExpiry(item.access.membership.expiry) : "-",
                                    icon: item.access.membership.active ? "check" : null,
                                    class: item.access.membership.active ? 'activated' : null
                                },
                                { 
                                    icon: item.access.status == 'JOIN_DISALLOWED' ? 'close': 'check'
                                }
                            ],
                            false);
                    });
                }
            }
        }

        class GroupInfoView extends GroupsViewBase {
            constructor(model) {
                super('#jit-groupinfo-view');

                console.assert(model);

                this.constraints = new mdc.list.MDCList(this.select('.jit-group-constraints').get(0));
                this.details = new mdc.list.MDCList(this.select('.jit-group-details').get(0));
                this.privileges = new mdc.list.MDCList(this.select('.jit-group-privileges').get(0));
                this.membership = new mdc.list.MDCList(this.select('.jit-group-membership').get(0));
                this.form = this.select('form');

                this.select('button[type="submit"]').unbind('click').click(async () => {
                    var dialog = new WaitDialog();
                    dialog.showAsync();

                    try {
                        this._bind(await model.postback(this.select('form').serialize()));
                    }
                    catch (e) {
                        document.appbar.showError(e, false);
                    }
                    finally {
                        dialog.close();
                    }
                });

                this._bind(model.content);
            }

            _bind(groupInfo) {
                this.constraints.clearRows();
                this.membership.clearRows();
                this.privileges.clearRows();
                this.details.clearRows();
                this.form.empty();
                this.form.append($(`<input type='hidden' name='__ignore' value='0'>`)); // Ensure there's at least one field.
                this.formFields = []
                this.select('.jit-form').show();

                //
                // Details.
                //
                this.select('.jit-provisioner-name')
                    .text(groupInfo.provisioner.name)
                    .prop('href', `#!/${groupInfo.provisioner.self.href}`);
                this.select('.jit-system-name')
                    .text(groupInfo.system.name)
                    .prop('href', `#!/${groupInfo.system.self.href}`);
                this.select('.jit-group-name').text(groupInfo.name);
                this.select('.jit-group-description').text(groupInfo.description);

                this.details.addRow({
                    icon: 'group',
                    primary: groupInfo.cloudIdentityGroup
                });

                if (groupInfo.access.membership.active) {
                    this.membership.addRow({
                        icon: 'check',
                        primary: 'You are a member of this group'
                    });
                    this.membership.addRow({
                        icon: 'schedule',
                        primary: `Your membership expires on ${new Date(groupInfo.access.membership.expiry * 1000).toLocaleString()}`
                    });
                }
                else {
                    this.membership.addRow({
                        primary: "You are not a member of this group",
                        icon: 'close'
                    });
                }

                if (groupInfo.access.status == 'JOIN_DISALLOWED') {
                    this.membership.addRow({
                        primary: "You don't have sufficient access to join this group",
                        icon: 'close'
                    });
                }
                else if (groupInfo.access.status == 'JOIN_ALLOWED_WITH_APPROVAL') {
                    this.membership.addRow({
                        primary: "You can request to join this group",
                        icon: 'check'
                    });
                }
                else if (groupInfo.access.status == 'JOIN_ALLOWED_WITHOUT_APPROVAL') {
                    this.membership.addRow({
                        primary: "You can join this group without approval",
                        icon: 'check'
                    });
                }

                //
                // Privileges.
                //
                if (groupInfo.privileges) {
                    groupInfo.privileges.forEach(item => {
                        this.privileges.addRow({
                            primary: item.description,
                            icon: 'badge'
                        });
                    });
                }

                //
                // Constraints.
                //
                if (groupInfo.access.satisfiedConstraints) {
                    groupInfo.access.satisfiedConstraints.forEach(item => {
                        this.constraints.addRow({
                            primary: item.description,
                            icon: 'check'
                        });
                    });
                }

                if (groupInfo.access.unsatisfiedConstraints) {
                    groupInfo.access.unsatisfiedConstraints.forEach(item => {
                        this.constraints.addRow({
                            primary: item.description,
                            icon: 'exclamation'
                        });
                    });
                }

                switch (groupInfo.access.status) {
                    case 'JOIN_ALLOWED_WITHOUT_APPROVAL':
                    case 'JOIN_ALLOWED_WITH_APPROVAL':
                    case 'JOINED':
                        this.select('.jit-form').show();
                        groupInfo.access.input.forEach(item => {
                            this._addInput(item);
                        });
                        break;

                    case 'JOIN_APPROVED':
                    case 'JOIN_REQUESTED':
                    case 'JOIN_DISALLOWED':
                        this.select('.jit-form').hide();
                }
            }

            _localDateFromDuration(durationInSeconds) {
                const date = new Date(new Date().getTime() + durationInSeconds * 1000);
                const shiftedDate = new Date(date - (date.getTimezoneOffset() * 60 * 1000))

                // Cut seconds to ensure compatibility with datetime-local fields.
                return shiftedDate.toISOString().substring(0, 16);
            }

            _addInput(input) {
                switch (input.type) {
                    case "String": {
                        const element = $(`
                            <label class="mdc-text-field mdc-text-field--outlined">
                                <span class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <span class="mdc-notched-outline__notch">
                                        <span class="mdc-floating-label jit-description"></span>
                                    </span>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </span>
                                <input type="text" class="mdc-text-field__input" name="${input.name}" ${input.isRequired ? 'required' : ''} autocomplete="off">
                            </label>`);
                        this.form.append(element);

                        element.find('.jit-description').text(input.description);

                        if (input.minInclusive) {
                            element.find('input').prop('minlength', input.minInclusive);
                        }

                        if (input.maxInclusive) {
                            element.find('input').prop('maxlength', input.maxInclusive);
                        }

                        const textField = new mdc.textField.MDCTextField(element.get(0));
                        this.formFields.push(textField);
                        break;
                    }

                    case "Boolean": {
                        const element = $(`
                            <div class="mdc-form-field" style="display: flex">
                              <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control" name="${input.name}" id="${input.name}"/>
                                <div class="mdc-checkbox__background">
                                  <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                  </svg>
                                  <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                                <div class="mdc-checkbox__focus-ring"></div>
                              </div>
                              <label class="jit-description" for="${input.name}"></label>
                            </div>`);
                        this.form.append(element);

                        element.find('.jit-description').text(input.description);

                        const checkbox = new mdc.checkbox.MDCCheckbox(element.find('.mdc-checkbox').get(0));
                        const formField = new mdc.formField.MDCFormField(element.get(0));
                        formField.input = checkbox;
                        break;
                    }

                    case "Duration": {
                        const element = $(`
                             <label class="mdc-text-field mdc-text-field--outlined">
                                 <span class="mdc-notched-outline">
                                     <span class="mdc-notched-outline__leading"></span>
                                     <span class="mdc-notched-outline__notch">
                                        <span class="mdc-floating-label jit-description"></span>
                                     </span>
                                     <span class="mdc-notched-outline__trailing"></span>
                                 </span>
                                 <input type="datetime-local" class="mdc-text-field__input" ${input.isRequired ? 'required' : ''}>
                                 <input type="hidden" name="${input.name}">
                             </label>`);
                        this.form.append(element);

                        element.find('.jit-description').text(input.description);

                        const datetimeInput = element.find('input[type="datetime-local"]');
                        const durationInput = element.find('input[type="hidden"]');

                        if (input.minInclusive) {
                            datetimeInput.prop('min', this._localDateFromDuration(input.minInclusive));
                        }

                        if (input.maxInclusive) {
                            datetimeInput.prop('max', this._localDateFromDuration(input.maxInclusive));
                            datetimeInput.prop('value', this._localDateFromDuration(input.maxInclusive));
                            durationInput.val(input.maxInclusive);
                        }

                        //
                        // Convert the date into a duration and update the hidden form field.
                        //
                        datetimeInput.on("change", e => {
                            const durationInSec = Math.floor((Date.parse(datetimeInput.val()) - new Date().getTime()) / 1000);
                            durationInput.val(durationInSec);
                        });

                        const textField = new mdc.textField.MDCTextField(element.get(0));
                        this.formFields.push(textField);
                        break;
                    }

                    case "Long": {
                        const element = $(`
                             <label class="mdc-text-field mdc-text-field--outlined">
                                 <span class="mdc-notched-outline">
                                     <span class="mdc-notched-outline__leading"></span>
                                     <span class="mdc-notched-outline__notch">
                                        <span class="mdc-floating-label jit-description"></span>
                                     </span>
                                     <span class="mdc-notched-outline__trailing"></span>
                                 </span>
                                 <input type="number" name="${input.name}" class="mdc-text-field__input" ${input.isRequired ? 'required' : ''}>
                             </label>`);
                        this.form.append(element);

                        element.find('.jit-description').text(input.description);

                        const datetimeInput = element.find('input');
                        if (input.minInclusive) {
                            datetimeInput.prop('min', this._localDateFromDuration(input.minInclusive));
                        }

                        if (input.maxInclusive) {
                            datetimeInput.prop('max', this._localDateFromDuration(input.maxInclusive));
                        }

                        const textField = new mdc.textField.MDCTextField(element.get(0));
                        this.formFields.push(textField);
                        break;
                    }

                    default:
                        break;
                }
            } 
        }

        async function routeToView() {
            let view;
            try {
                const model = await document.appbar.loadModel();
                if (!model) {
                    return;
                }

                switch (model.content._type) {
                    case "EnvironmentInfo":
                        view = new EnvironmentInfoView(model);
                        await view.showAsync();
                        break;

                    case "SystemInfo":
                        view = new SystemInfoView(model);
                        await view.showAsync();
                        break;

                    case "GroupInfo":
                        view = new GroupInfoView(model);
                        await view.showAsync();
                        break;
                }
                
            }
            catch (e) {
                if (view) {
                    view.cancelView(e);
                }

                document.appbar.showError(e ?? "No provisioner selected", true);
            }
        }

        window.onhashchange = routeToView;
        $(document).ready(routeToView);
    </script>
  </body>
</html>